# ==============================================================================
# EXAMPLE: Using DevSecOps Toolbox Docker Image
# ==============================================================================
# This pipeline uses a pre-built Docker image with all security tools installed
# Repository: yourorg/bitbucket-pipeline-library
# Image: yourorg/devsecops-toolbox:1.0.0
#
# SETUP REQUIRED:
# 1. Build toolbox image: see .pipeline-library/docker/devsecops-toolbox/README.md
# 2. Push to Docker registry
# 3. Replace 'yourorg' with your organization name
# ==============================================================================

# Use the DevSecOps toolbox as base image (all tools pre-installed)
image: yourorg/devsecops-toolbox:1.0.0

options:
  max-time: 120
  docker: true

definitions:
  caches:
    maven-local: ~/.m2/repository

  # Download shared scripts from pipeline library
  scripts:
    - &download-shared-scripts |
      echo "Downloading shared scripts from pipeline library..."
      git clone --depth 1 --branch main \
        https://bitbucket.org/yourorg/bitbucket-pipeline-library.git /tmp/pipeline-lib
      cp -r /tmp/pipeline-lib/scripts/* ./scripts/
      chmod +x scripts/**/*.sh
      echo "âœ“ Shared scripts downloaded"

pipelines:
  # ==============================================================================
  # DEFAULT PIPELINE - Using Toolbox Image
  # ==============================================================================
  default:
    - step:
        name: ðŸ”’ Security Scans
        caches:
          - maven
          - maven-local
        script:
          # Download shared scripts
          - *download-shared-scripts

          # All tools are already installed in the image!
          # Just run the scripts directly

          # Secrets scanning
          - echo "=== Secrets Scanning ==="
          - export FAIL_ON_SECRETS=true
          - ./scripts/security/security-secrets-scan.sh

          # Dependency scanning
          - echo "=== Dependency Scanning ==="
          - export CVSS_THRESHOLD=7.0
          - export FAIL_ON_CVSS=true
          - ./scripts/security/security-sca-scan.sh

          # Dockerfile scanning
          - echo "=== Dockerfile Scanning ==="
          - ./scripts/security/security-dockerfile-scan.sh

        artifacts:
          - security-reports/**

    - step:
        name: Build & Test
        caches:
          - maven
          - maven-local
        script:
          - mvn clean test package

    - step:
        name: ðŸ“¦ Generate SBOM
        caches:
          - maven-local
        script:
          - *download-shared-scripts
          - ./scripts/security/security-sbom-generate.sh
        artifacts:
          - security-reports/sbom/**

  # ==============================================================================
  # DEVELOP BRANCH - Full Pipeline with Toolbox
  # ==============================================================================
  branches:
    develop:
      # PHASE 1: Security First (using pre-installed tools)
      - step:
          name: ðŸ”’ Shift-Left Security
          caches:
            - maven
            - maven-local
          script:
            - *download-shared-scripts

            # Secrets scan (BLOCKING)
            - export FAIL_ON_SECRETS=true
            - ./scripts/security/security-secrets-scan.sh

            # Dependency scan (BLOCKING on HIGH)
            - export CVSS_THRESHOLD=7.0
            - export FAIL_ON_CVSS=true
            - ./scripts/security/security-sca-scan.sh

          artifacts:
            - security-reports/**

      # PHASE 2: Parallel Testing
      - parallel:
          - step:
              name: Unit Tests
              caches:
                - maven
                - maven-local
              script:
                - *download-shared-scripts
                - ./scripts/test.sh

          - step:
              name: Integration Tests
              services:
                - docker
              caches:
                - maven
                - maven-local
              script:
                - *download-shared-scripts
                - export DOCKER_REQUIRED=true
                - ./scripts/integration-test.sh

          - step:
              name: Code Quality
              caches:
                - maven
                - maven-local
              script:
                - *download-shared-scripts
                - export SONAR_ENABLED=${SONAR_ENABLED:-false}
                - ./scripts/quality.sh

      # PHASE 3: Build
      - step:
          name: Build & Package
          caches:
            - maven
            - maven-local
          script:
            - *download-shared-scripts
            - ./scripts/build.sh
            - ./scripts/package.sh
          artifacts:
            - target/*.jar
            - build-info/**

      # PHASE 4: SBOM Generation
      - step:
          name: ðŸ“¦ Generate SBOM
          script:
            - *download-shared-scripts
            - export SBOM_FORMAT=cyclonedx
            - ./scripts/security/security-sbom-generate.sh
          artifacts:
            - security-reports/sbom/**

      # PHASE 5: Container Security
      - step:
          name: ðŸ”’ Container Security
          services:
            - docker
          script:
            - *download-shared-scripts

            # Scan Dockerfile
            - ./scripts/security/security-dockerfile-scan.sh

            # Build container
            - ./scripts/docker-build.sh

            # Scan container with Trivy (pre-installed)
            - source build-info/docker-image.txt
            - |
              trivy image \
                --severity CRITICAL,HIGH,MEDIUM \
                --exit-code 1 \
                --format json \
                --output security-reports/trivy-scan.json \
                $DOCKER_IMAGE || echo "Vulnerabilities found"

            # Generate container SBOM with Syft (pre-installed)
            - syft $DOCKER_IMAGE -o cyclonedx-json > security-reports/container-sbom.json

          artifacts:
            - security-reports/**
            - build-info/**

      # PHASE 6: IaC Security
      - step:
          name: ðŸ”’ IaC Security
          script:
            - *download-shared-scripts
            - export HELM_CHART_PATH=./helm-chart
            - export FAIL_ON_HIGH=false
            - ./scripts/security/security-iac-scan.sh
          artifacts:
            - security-reports/iac/**

      # PHASE 7: Deploy
      - step:
          name: Deploy to Development
          deployment: development
          script:
            - *download-shared-scripts
            - export NAMESPACE=dev
            - ./scripts/deploy-dev.sh

  # ==============================================================================
  # FEATURE BRANCHES - Quick Security Validation
  # ==============================================================================
  branches:
    'feature/**':
      - step:
          name: ðŸ”’ Quick Security Check
          caches:
            - maven
            - maven-local
          script:
            - *download-shared-scripts

            # Critical checks only
            - export FAIL_ON_SECRETS=true
            - ./scripts/security/security-secrets-scan.sh

            - export CVSS_THRESHOLD=9.0  # Only critical
            - export FAIL_ON_CVSS=true
            - ./scripts/security/security-sca-scan.sh

      - step:
          name: Build & Test
          caches:
            - maven
            - maven-local
          script:
            - *download-shared-scripts
            - ./scripts/test.sh
            - ./scripts/build.sh

  # ==============================================================================
  # CUSTOM PIPELINES
  # ==============================================================================
  custom:
    # Full security audit using toolbox
    full-security-audit:
      - step:
          name: ðŸ”’ Complete Security Audit
          caches:
            - maven
            - maven-local
          script:
            - *download-shared-scripts

            # Run all security scans
            - echo "=== Secrets Scanning ==="
            - ./scripts/security/security-secrets-scan.sh || true

            - echo "=== Dependency Scanning ==="
            - export CVSS_THRESHOLD=0  # Report all
            - ./scripts/security/security-sca-scan.sh || true

            - echo "=== Dockerfile Scanning ==="
            - ./scripts/security/security-dockerfile-scan.sh || true

            - echo "=== IaC Scanning ==="
            - ./scripts/security/security-iac-scan.sh || true

            # Generate reports
            - echo "=== Generating SBOM ==="
            - ./scripts/security/security-sbom-generate.sh || true

          artifacts:
            - security-reports/**

    # Quick build without security
    quick-build:
      - step:
          name: Quick Build
          caches:
            - maven
          script:
            - mvn clean package -DskipTests

# ==============================================================================
# NOTES
# ==============================================================================
# Advantages of using Toolbox Image:
# - âœ… All tools pre-installed (no installation time)
# - âœ… Faster pipeline execution
# - âœ… Consistent tool versions
# - âœ… Easy to maintain (update image once)
# - âœ… Works offline (tools baked into image)
#
# Prerequisites:
# 1. Build toolbox image:
#    cd .pipeline-library/docker/devsecops-toolbox
#    docker build -t yourorg/devsecops-toolbox:1.0.0 .
#
# 2. Push to registry:
#    docker push yourorg/devsecops-toolbox:1.0.0
#
# 3. Create pipeline library repository with scripts:
#    https://bitbucket.org/yourorg/bitbucket-pipeline-library
#
# 4. Update this file:
#    - Replace 'yourorg' with your organization
#    - Update repository URLs
# ==============================================================================
