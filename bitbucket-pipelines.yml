# ==============================================================================
# Optimized Bitbucket Pipeline with Reusable Pipes
# ==============================================================================
# Clean, maintainable CI/CD using YAML anchors and Bitbucket Pipes
# ==============================================================================

image: alpine:3.19

options:
  max-time: 120

# ==============================================================================
# Reusable Definitions (YAML Anchors)
# ==============================================================================
definitions:
  # Common pipe configurations
  pipes:
    build: &pipe-build
      pipe: docker://nayaksuraj/build-pipe:1.0.0

    test: &pipe-test
      pipe: docker://nayaksuraj/test-pipe:1.0.0
      variables:
        INTEGRATION_TESTS: "true"
        COVERAGE_ENABLED: "true"

    quality: &pipe-quality
      pipe: docker://nayaksuraj/quality-pipe:1.0.0
      variables:
        SONAR_ENABLED: "true"
        SONAR_TOKEN: $SONAR_TOKEN
        SONAR_HOST_URL: $SONAR_HOST_URL

    security: &pipe-security
      pipe: docker://nayaksuraj/security-pipe:1.0.0
      variables:
        SECRETS_SCAN: "true"
        SCA_SCAN: "true"
        SBOM_GENERATE: "true"

    docker: &pipe-docker
      pipe: docker://nayaksuraj/docker-pipe:1.0.0
      variables:
        DOCKER_REGISTRY: $DOCKER_REGISTRY
        DOCKER_REPOSITORY: $DOCKER_REPOSITORY
        DOCKER_USERNAME: $DOCKER_USERNAME
        DOCKER_PASSWORD: $DOCKER_PASSWORD
        SCAN_IMAGE: "true"
        PUSH_IMAGE: "true"

    helm: &pipe-helm
      pipe: docker://nayaksuraj/helm-pipe:1.0.0
      variables:
        HELM_CHART_PATH: "./helm-chart"
        LINT_CHART: "true"
        PACKAGE_CHART: "true"

    deploy-dev: &pipe-deploy-dev
      pipe: docker://nayaksuraj/deploy-pipe:1.0.0
      variables:
        ENVIRONMENT: "dev"
        NAMESPACE: "dev"
        KUBECONFIG: $KUBECONFIG
        WAIT_FOR_ROLLOUT: "true"

    deploy-stage: &pipe-deploy-stage
      pipe: docker://nayaksuraj/deploy-pipe:1.0.0
      variables:
        ENVIRONMENT: "stage"
        NAMESPACE: "staging"
        KUBECONFIG: $KUBECONFIG
      trigger: manual

    deploy-prod: &pipe-deploy-prod
      pipe: docker://nayaksuraj/deploy-pipe:1.0.0
      variables:
        ENVIRONMENT: "prod"
        NAMESPACE: "production"
        KUBECONFIG: $KUBECONFIG
        WAIT_FOR_ROLLOUT: "true"
      trigger: manual

# ==============================================================================
# Pipeline Workflows
# ==============================================================================
pipelines:
  default:
    - *pipe-build
    - *pipe-test

  branches:
    # Feature branches: Quick validation
    'feature/**':
      - *pipe-build
      - parallel:
          - *pipe-test
          - *pipe-quality
          - pipe: docker://nayaksuraj/security-pipe:1.0.0
            variables:
              SECRETS_SCAN: "true"
              FAIL_ON_HIGH: "false"

    # Develop: Full CI + Deploy to dev
    develop:
      - *pipe-build
      - parallel:
          - *pipe-test
          - *pipe-quality
          - <<: *pipe-security
            variables:
              SECRETS_SCAN: "true"
              SCA_SCAN: "true"
              SBOM_GENERATE: "true"
              FAIL_ON_HIGH: "false"
      - *pipe-docker
      - <<: *pipe-helm
        variables:
          HELM_CHART_PATH: "./helm-chart"
          LINT_CHART: "true"
          PACKAGE_CHART: "true"
          PUSH_CHART: "${HELM_PUSH:-false}"
          HELM_REGISTRY: $HELM_REGISTRY
          HELM_REGISTRY_USERNAME: $HELM_REGISTRY_USERNAME
          HELM_REGISTRY_PASSWORD: $HELM_REGISTRY_PASSWORD
      - *pipe-deploy-dev

    # Main: Deploy to dev + manual stage
    main:
      - *pipe-build
      - parallel:
          - *pipe-test
          - *pipe-quality
          - <<: *pipe-security
            variables:
              SECRETS_SCAN: "true"
              SCA_SCAN: "true"
              SAST_SCAN: "true"
              SBOM_GENERATE: "true"
              IAC_SCAN: "true"
              DOCKERFILE_SCAN: "true"
              FAIL_ON_HIGH: "true"
      - *pipe-docker
      - <<: *pipe-helm
        variables:
          HELM_CHART_PATH: "./helm-chart"
          LINT_CHART: "true"
          PACKAGE_CHART: "true"
          PUSH_CHART: "true"
      - *pipe-deploy-dev
      - *pipe-deploy-stage

    # Release: Full pipeline with production
    release:
      - *pipe-build
      - parallel:
          - <<: *pipe-test
            variables:
              INTEGRATION_TESTS: "true"
              COVERAGE_ENABLED: "true"
              COVERAGE_THRESHOLD: "80"
          - <<: *pipe-quality
            variables:
              SONAR_ENABLED: "true"
              SONAR_TOKEN: $SONAR_TOKEN
              QUALITY_GATE_WAIT: "true"
          - <<: *pipe-security
            variables:
              SECRETS_SCAN: "true"
              SCA_SCAN: "true"
              SAST_SCAN: "true"
              SBOM_GENERATE: "true"
              IAC_SCAN: "true"
              DOCKERFILE_SCAN: "true"
              FAIL_ON_HIGH: "true"
      - <<: *pipe-docker
        variables:
          DOCKER_REGISTRY: $DOCKER_REGISTRY
          DOCKER_REPOSITORY: $DOCKER_REPOSITORY
          DOCKER_USERNAME: $DOCKER_USERNAME
          DOCKER_PASSWORD: $DOCKER_PASSWORD
          SCAN_IMAGE: "true"
          TRIVY_SEVERITY: "CRITICAL,HIGH"
          PUSH_IMAGE: "true"
      - <<: *pipe-helm
        variables:
          HELM_CHART_PATH: "./helm-chart"
          LINT_CHART: "true"
          PACKAGE_CHART: "true"
          PUSH_CHART: "true"
      - *pipe-deploy-dev
      - *pipe-deploy-stage
      - <<: *pipe-deploy-prod
        variables:
          ENVIRONMENT: "prod"
          NAMESPACE: "production"
          KUBECONFIG: $KUBECONFIG
          WAIT_FOR_ROLLOUT: "true"
          ROLLOUT_TIMEOUT: "600"

  # Tag-based production deployment
  tags:
    'v*':
      - *pipe-build
      - *pipe-test
      - <<: *pipe-security
        variables:
          SECRETS_SCAN: "true"
          SCA_SCAN: "true"
          SBOM_GENERATE: "true"
          FAIL_ON_HIGH: "true"
      - <<: *pipe-docker
        variables:
          DOCKER_REGISTRY: $DOCKER_REGISTRY
          DOCKER_REPOSITORY: $DOCKER_REPOSITORY
          DOCKER_USERNAME: $DOCKER_USERNAME
          DOCKER_PASSWORD: $DOCKER_PASSWORD
          IMAGE_TAG: $BITBUCKET_TAG
          SCAN_IMAGE: "true"
          PUSH_IMAGE: "true"
      - <<: *pipe-helm
        variables:
          HELM_CHART_PATH: "./helm-chart"
          CHART_VERSION: $BITBUCKET_TAG
          PUSH_CHART: "true"
      - pipe: docker://nayaksuraj/deploy-pipe:1.0.0
        variables:
          ENVIRONMENT: "prod"
          NAMESPACE: "production"
          KUBECONFIG: $KUBECONFIG
          IMAGE_TAG: $BITBUCKET_TAG
          WAIT_FOR_ROLLOUT: "true"
        trigger: manual

  # Pull request validation
  pull-requests:
    '**':
      - *pipe-build
      - parallel:
          - <<: *pipe-test
            variables:
              COVERAGE_ENABLED: "true"
          - pipe: docker://nayaksuraj/quality-pipe:1.0.0
            variables:
              SONAR_ENABLED: "${SONAR_ENABLED:-false}"
          - pipe: docker://nayaksuraj/security-pipe:1.0.0
            variables:
              SECRETS_SCAN: "true"
              SCA_SCAN: "true"

  # Custom pipelines
  custom:
    security-audit:
      - pipe: docker://nayaksuraj/security-pipe:1.0.0
        variables:
          SECRETS_SCAN: "true"
          SCA_SCAN: "true"
          SAST_SCAN: "true"
          SBOM_GENERATE: "true"
          IAC_SCAN: "true"
          DOCKERFILE_SCAN: "true"
          CONTAINER_SCAN: "true"
          FAIL_ON_HIGH: "false"
          DEBUG: "true"

    quick-build:
      - pipe: docker://nayaksuraj/build-pipe:1.0.0
        variables:
          BUILD_ARGS: "-DskipTests"
      - pipe: docker://nayaksuraj/test-pipe:1.0.0
        variables:
          TEST_ARGS: "--quick"

    deploy-dev:
      - *pipe-deploy-dev

    deploy-stage:
      - *pipe-deploy-stage

    deploy-prod:
      - *pipe-deploy-prod
