# ==============================================================================
# Bitbucket Pipeline Using Custom Pipes (Clean & Reusable)
# ==============================================================================
# This pipeline demonstrates how to use custom pipes for clean, maintainable CI/CD
#
# BEFORE: 18 scripts, 400+ lines of YAML, duplicated logic
# AFTER:  7 pipes, 100 lines of YAML, fully reusable
# ==============================================================================

image: alpine:3.19

# ==============================================================================
# Pipeline Options
# ==============================================================================
options:
  max-time: 120

# ==============================================================================
# Git Flow Pipeline with Pipes
# ==============================================================================
pipelines:
  # Default pipeline for all branches
  default:
    - pipe: docker://nayaksuraj/build-pipe:1.0.0
    - pipe: docker://nayaksuraj/test-pipe:1.0.0

  # ==============================================================================
  # Feature Branches: Build, Test, Quality
  # ==============================================================================
  branches:
    'feature/**':
      - pipe: docker://nayaksuraj/build-pipe:1.0.0
        variables:
          BUILD_ARGS: "-DskipTests"

      - parallel:
          - pipe: docker://nayaksuraj/test-pipe:1.0.0
            variables:
              INTEGRATION_TESTS: "true"
              COVERAGE_ENABLED: "true"

          - pipe: docker://nayaksuraj/quality-pipe:1.0.0
            variables:
              SONAR_ENABLED: "${SONAR_ENABLED:-false}"
              CHECKSTYLE_ENABLED: "true"

    # ==========================================================================
    # Develop Branch: Full CI/CD Pipeline
    # ==========================================================================
    develop:
      # CI Phase
      - pipe: docker://nayaksuraj/build-pipe:1.0.0

      - parallel:
          - pipe: docker://nayaksuraj/test-pipe:1.0.0
            variables:
              INTEGRATION_TESTS: "true"
              COVERAGE_ENABLED: "true"
              COVERAGE_THRESHOLD: "80"

          - pipe: docker://nayaksuraj/quality-pipe:1.0.0
            variables:
              SONAR_ENABLED: "true"
              SONAR_TOKEN: $SONAR_TOKEN
              SONAR_HOST_URL: $SONAR_HOST_URL

          - pipe: docker://nayaksuraj/security-pipe:1.0.0
            variables:
              SECRETS_SCAN: "true"
              SCA_SCAN: "true"
              SBOM_GENERATE: "true"
              FAIL_ON_HIGH: "false"

      # CD Phase
      - pipe: docker://nayaksuraj/docker-pipe:1.0.0
        variables:
          DOCKER_REGISTRY: $DOCKER_REGISTRY
          DOCKER_REPOSITORY: $DOCKER_REPOSITORY
          DOCKER_USERNAME: $DOCKER_USERNAME
          DOCKER_PASSWORD: $DOCKER_PASSWORD
          SCAN_IMAGE: "true"
          PUSH_IMAGE: "true"

      - parallel:
          - pipe: docker://nayaksuraj/helm-pipe:1.0.0
            variables:
              HELM_CHART_PATH: "./helm-chart"
              LINT_CHART: "true"
              PACKAGE_CHART: "true"
              PUSH_CHART: "${HELM_PUSH:-false}"
              HELM_REGISTRY: $HELM_REGISTRY
              HELM_REGISTRY_USERNAME: $HELM_REGISTRY_USERNAME
              HELM_REGISTRY_PASSWORD: $HELM_REGISTRY_PASSWORD

      - pipe: docker://nayaksuraj/deploy-pipe:1.0.0
        variables:
          ENVIRONMENT: "dev"
          NAMESPACE: "dev"
          KUBECONFIG: $KUBECONFIG
          RELEASE_NAME: "app"
          HELM_CHART_PATH: "./helm-chart"
          WAIT_FOR_ROLLOUT: "true"

    # ==========================================================================
    # Main Branch: Deploy to Dev + Manual Stage
    # ==========================================================================
    main:
      # CI Phase
      - pipe: docker://nayaksuraj/build-pipe:1.0.0

      - parallel:
          - pipe: docker://nayaksuraj/test-pipe:1.0.0
            variables:
              INTEGRATION_TESTS: "true"
              COVERAGE_ENABLED: "true"

          - pipe: docker://nayaksuraj/quality-pipe:1.0.0
            variables:
              SONAR_ENABLED: "true"
              SONAR_TOKEN: $SONAR_TOKEN

          - pipe: docker://nayaksuraj/security-pipe:1.0.0
            variables:
              SECRETS_SCAN: "true"
              SCA_SCAN: "true"
              SAST_SCAN: "true"
              SBOM_GENERATE: "true"
              IAC_SCAN: "true"
              DOCKERFILE_SCAN: "true"
              FAIL_ON_HIGH: "true"

      # CD Phase
      - pipe: docker://nayaksuraj/docker-pipe:1.0.0
        variables:
          DOCKER_REGISTRY: $DOCKER_REGISTRY
          DOCKER_REPOSITORY: $DOCKER_REPOSITORY
          DOCKER_USERNAME: $DOCKER_USERNAME
          DOCKER_PASSWORD: $DOCKER_PASSWORD
          SCAN_IMAGE: "true"
          PUSH_IMAGE: "true"

      - pipe: docker://nayaksuraj/helm-pipe:1.0.0
        variables:
          HELM_CHART_PATH: "./helm-chart"
          LINT_CHART: "true"
          PACKAGE_CHART: "true"
          PUSH_CHART: "true"

      - pipe: docker://nayaksuraj/deploy-pipe:1.0.0
        variables:
          ENVIRONMENT: "dev"
          NAMESPACE: "dev"
          KUBECONFIG: $KUBECONFIG

      - pipe: docker://nayaksuraj/deploy-pipe:1.0.0
        variables:
          ENVIRONMENT: "stage"
          NAMESPACE: "staging"
          KUBECONFIG: $KUBECONFIG
        trigger: manual

    # ==========================================================================
    # Release Branch: Full Pipeline with Production Deployment
    # ==========================================================================
    release:
      # CI Phase
      - pipe: docker://nayaksuraj/build-pipe:1.0.0

      - parallel:
          - pipe: docker://nayaksuraj/test-pipe:1.0.0
            variables:
              INTEGRATION_TESTS: "true"
              COVERAGE_ENABLED: "true"
              COVERAGE_THRESHOLD: "80"

          - pipe: docker://nayaksuraj/quality-pipe:1.0.0
            variables:
              SONAR_ENABLED: "true"
              SONAR_TOKEN: $SONAR_TOKEN
              QUALITY_GATE_WAIT: "true"

          - pipe: docker://nayaksuraj/security-pipe:1.0.0
            variables:
              SECRETS_SCAN: "true"
              SCA_SCAN: "true"
              SAST_SCAN: "true"
              SBOM_GENERATE: "true"
              IAC_SCAN: "true"
              DOCKERFILE_SCAN: "true"
              CONTAINER_SCAN: "false"  # Will scan after docker build
              FAIL_ON_HIGH: "true"

      # CD Phase
      - pipe: docker://nayaksuraj/docker-pipe:1.0.0
        variables:
          DOCKER_REGISTRY: $DOCKER_REGISTRY
          DOCKER_REPOSITORY: $DOCKER_REPOSITORY
          DOCKER_USERNAME: $DOCKER_USERNAME
          DOCKER_PASSWORD: $DOCKER_PASSWORD
          SCAN_IMAGE: "true"
          TRIVY_SEVERITY: "CRITICAL,HIGH"
          PUSH_IMAGE: "true"

      - pipe: docker://nayaksuraj/helm-pipe:1.0.0
        variables:
          HELM_CHART_PATH: "./helm-chart"
          LINT_CHART: "true"
          PACKAGE_CHART: "true"
          PUSH_CHART: "true"

      # Deploy to environments
      - pipe: docker://nayaksuraj/deploy-pipe:1.0.0
        variables:
          ENVIRONMENT: "dev"
          NAMESPACE: "dev"
          KUBECONFIG: $KUBECONFIG

      - pipe: docker://nayaksuraj/deploy-pipe:1.0.0
        variables:
          ENVIRONMENT: "stage"
          NAMESPACE: "staging"
          KUBECONFIG: $KUBECONFIG
        trigger: manual

      - pipe: docker://nayaksuraj/deploy-pipe:1.0.0
        variables:
          ENVIRONMENT: "prod"
          NAMESPACE: "production"
          KUBECONFIG: $KUBECONFIG
          WAIT_FOR_ROLLOUT: "true"
          ROLLOUT_TIMEOUT: "600"
        trigger: manual

  # ==============================================================================
  # Tag-Based Production Deployment
  # ==============================================================================
  tags:
    'v*':
      - pipe: docker://nayaksuraj/build-pipe:1.0.0

      - pipe: docker://nayaksuraj/test-pipe:1.0.0
        variables:
          INTEGRATION_TESTS: "true"

      - pipe: docker://nayaksuraj/security-pipe:1.0.0
        variables:
          SECRETS_SCAN: "true"
          SCA_SCAN: "true"
          SBOM_GENERATE: "true"
          FAIL_ON_HIGH: "true"

      - pipe: docker://nayaksuraj/docker-pipe:1.0.0
        variables:
          DOCKER_REGISTRY: $DOCKER_REGISTRY
          DOCKER_REPOSITORY: $DOCKER_REPOSITORY
          DOCKER_USERNAME: $DOCKER_USERNAME
          DOCKER_PASSWORD: $DOCKER_PASSWORD
          IMAGE_TAG: $BITBUCKET_TAG
          SCAN_IMAGE: "true"
          PUSH_IMAGE: "true"

      - pipe: docker://nayaksuraj/helm-pipe:1.0.0
        variables:
          HELM_CHART_PATH: "./helm-chart"
          CHART_VERSION: $BITBUCKET_TAG
          PUSH_CHART: "true"

      - pipe: docker://nayaksuraj/deploy-pipe:1.0.0
        variables:
          ENVIRONMENT: "prod"
          NAMESPACE: "production"
          KUBECONFIG: $KUBECONFIG
          IMAGE_TAG: $BITBUCKET_TAG
          WAIT_FOR_ROLLOUT: "true"
        trigger: manual

  # ==============================================================================
  # Pull Request Validation
  # ==============================================================================
  pull-requests:
    '**':
      - pipe: docker://nayaksuraj/build-pipe:1.0.0

      - parallel:
          - pipe: docker://nayaksuraj/test-pipe:1.0.0
            variables:
              COVERAGE_ENABLED: "true"

          - pipe: docker://nayaksuraj/quality-pipe:1.0.0
            variables:
              SONAR_ENABLED: "${SONAR_ENABLED:-false}"

          - pipe: docker://nayaksuraj/security-pipe:1.0.0
            variables:
              SECRETS_SCAN: "true"
              SCA_SCAN: "true"

  # ==============================================================================
  # Custom Pipelines
  # ==============================================================================
  custom:
    # Full security audit
    security-audit:
      - pipe: docker://nayaksuraj/security-pipe:1.0.0
        variables:
          SECRETS_SCAN: "true"
          SCA_SCAN: "true"
          SAST_SCAN: "true"
          SBOM_GENERATE: "true"
          IAC_SCAN: "true"
          DOCKERFILE_SCAN: "true"
          CONTAINER_SCAN: "true"
          FAIL_ON_HIGH: "false"  # Report only
          DEBUG: "true"

    # Quick build and test
    quick-build:
      - pipe: docker://nayaksuraj/build-pipe:1.0.0
        variables:
          BUILD_ARGS: "-DskipTests"
      - pipe: docker://nayaksuraj/test-pipe:1.0.0
        variables:
          TEST_ARGS: "--quick"

    # Docker only
    docker-only:
      - pipe: docker://nayaksuraj/docker-pipe:1.0.0
        variables:
          DOCKER_REGISTRY: $DOCKER_REGISTRY
          DOCKER_USERNAME: $DOCKER_USERNAME
          DOCKER_PASSWORD: $DOCKER_PASSWORD
          SCAN_IMAGE: "true"
          PUSH_IMAGE: "false"

# ==============================================================================
# Benefits of Using Pipes:
# ==============================================================================
# ✅ 18 scripts → 7 reusable pipes
# ✅ 400+ lines YAML → 100 lines
# ✅ Duplicated logic → Single source of truth
# ✅ Hard to maintain → Easy to update (change pipe version)
# ✅ Project-specific → Works across all projects
# ✅ Manual updates → Automatic updates (pull new pipe version)
# ==============================================================================
