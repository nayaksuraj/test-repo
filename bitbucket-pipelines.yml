# ==============================================================================
# Universal Language-Agnostic Pipeline
# ==============================================================================
# This pipeline works with ANY language - Python, Java, Node.js, Go, Rust, etc.
# All pipes AUTO-DETECT your language and tools - NO configuration needed!
#
# Just copy this to your project and it works!
# ==============================================================================

image: atlassian/default-image:4

pipelines:
  # ==============================================================================
  # Pull Requests - Fast Feedback
  # ==============================================================================
  pull-requests:
    '**':
      # Lint & Type Check - Auto-detects language
      - pipe: docker://nayaksuraj/lint-pipe:1.0.0
        # Auto-detects: Python, JavaScript, TypeScript, Go, Java, Rust, Ruby
        # Runs: pre-commit, linting, formatting check, type checking

      # Run Tests - Auto-detects test framework
      - pipe: docker://nayaksuraj/test-pipe:1.0.0
        # Auto-detects: pytest, jest, go test, maven, gradle, etc.
        variables:
          COVERAGE_ENABLED: "true"

      # Security Scan - Auto-detects package manager
      - pipe: docker://nayaksuraj/security-pipe:1.0.0
        # Auto-detects: npm, pip, maven, go mod, cargo, etc.
        variables:
          SECRETS_SCAN: "true"
          SCA_SCAN: "true"
          FAIL_ON_HIGH: "false"

  # ==============================================================================
  # Develop Branch - Auto-Deploy to Dev
  # ==============================================================================
  branches:
    develop:
      # Lint & Type Check
      - pipe: docker://nayaksuraj/lint-pipe:1.0.0

      # Build - Auto-detects build tool
      - pipe: docker://nayaksuraj/build-pipe:1.0.0
        # Auto-detects: Maven, Gradle, npm, poetry, go, dotnet, cargo, etc.

      # Test with Coverage
      - pipe: docker://nayaksuraj/test-pipe:1.0.0
        variables:
          COVERAGE_ENABLED: "true"

      # Parallel Quality & Security
      - parallel:
          - pipe: docker://nayaksuraj/quality-pipe:1.0.0
            # Works with ALL languages via SonarQube
            variables:
              SONAR_ENABLED: "true"
              SONAR_TOKEN: $SONAR_TOKEN

          - pipe: docker://nayaksuraj/security-pipe:1.0.0
            variables:
              SBOM_GENERATE: "true"
              SAST_SCAN: "true"

      # Docker Build & Push - Completely agnostic
      - pipe: docker://nayaksuraj/docker-pipe:1.0.0
        # Works with ANY Dockerfile
        variables:
          DOCKER_REGISTRY: $DOCKER_REGISTRY
          DOCKER_REPOSITORY: $DOCKER_REPOSITORY
          DOCKER_USERNAME: $DOCKER_USERNAME
          DOCKER_PASSWORD: $DOCKER_PASSWORD
          SCAN_IMAGE: "true"

      # Deploy to Dev - Completely agnostic
      - pipe: docker://nayaksuraj/deploy-pipe:1.0.0
        # Works with ANY Kubernetes application
        variables:
          ENVIRONMENT: "dev"
          DEPLOY_NAMESPACE: "development"
          KUBECONFIG: $KUBECONFIG_DEV
          HELM_CHART_PATH: "./helm-chart"
          HELM_VALUES_FILE: "values-dev.yaml"

      # Notify - Completely agnostic
      - pipe: docker://nayaksuraj/slack-pipe:1.0.0
        # Works for ANY project
        variables:
          SLACK_WEBHOOK_URL: $SLACK_WEBHOOK_URL
          MESSAGE: "âœ… Deployed to DEV"
          ENVIRONMENT: "dev"

  # ==============================================================================
  # Main Branch - Deploy to Staging
  # ==============================================================================
    main:
      - pipe: docker://nayaksuraj/lint-pipe:1.0.0
      - pipe: docker://nayaksuraj/build-pipe:1.0.0
      - pipe: docker://nayaksuraj/test-pipe:1.0.0
        variables:
          COVERAGE_ENABLED: "true"

      - parallel:
          - pipe: docker://nayaksuraj/quality-pipe:1.0.0
            variables:
              SONAR_ENABLED: "true"
              SONAR_TOKEN: $SONAR_TOKEN
              QUALITY_GATE_ENABLED: "true"

          - pipe: docker://nayaksuraj/security-pipe:1.0.0
            variables:
              FAIL_ON_HIGH: "true"
              SAST_SCAN: "true"

      - pipe: docker://nayaksuraj/docker-pipe:1.0.0
        variables:
          DOCKER_REGISTRY: $DOCKER_REGISTRY
          DOCKER_REPOSITORY: $DOCKER_REPOSITORY
          DOCKER_USERNAME: $DOCKER_USERNAME
          DOCKER_PASSWORD: $DOCKER_PASSWORD
          SCAN_IMAGE: "true"
          TRIVY_EXIT_CODE: "1"

      - pipe: docker://nayaksuraj/helm-pipe:1.0.0
        variables:
          HELM_CHART_PATH: "./helm-chart"
          LINT_CHART: "true"
          PACKAGE_CHART: "true"

      - step:
          name: ðŸš€ Deploy to Staging
          deployment: staging
          trigger: manual
          script:
            - pipe: docker://nayaksuraj/deploy-pipe:1.0.0
              variables:
                ENVIRONMENT: "staging"
                DEPLOY_NAMESPACE: "staging"
                KUBECONFIG: $KUBECONFIG_STAGING
                HELM_CHART_PATH: "./helm-chart"
                HELM_VALUES_FILE: "values-staging.yaml"

      - pipe: docker://nayaksuraj/slack-pipe:1.0.0
        variables:
          SLACK_WEBHOOK_URL: $SLACK_WEBHOOK_URL
          MESSAGE: "âœ… Deployed to STAGING"
          ENVIRONMENT: "staging"

  # ==============================================================================
  # Tagged Releases - Production Deployment
  # ==============================================================================
  tags:
    'v*':
      - pipe: docker://nayaksuraj/lint-pipe:1.0.0
      - pipe: docker://nayaksuraj/build-pipe:1.0.0
      - pipe: docker://nayaksuraj/test-pipe:1.0.0
        variables:
          COVERAGE_ENABLED: "true"

      - pipe: docker://nayaksuraj/security-pipe:1.0.0
        variables:
          FAIL_ON_HIGH: "true"
          SAST_SCAN: "true"

      - pipe: docker://nayaksuraj/docker-pipe:1.0.0
        variables:
          DOCKER_REGISTRY: $DOCKER_REGISTRY
          DOCKER_REPOSITORY: $DOCKER_REPOSITORY
          DOCKER_USERNAME: $DOCKER_USERNAME
          DOCKER_PASSWORD: $DOCKER_PASSWORD
          IMAGE_TAG: "${BITBUCKET_TAG#v}"
          SCAN_IMAGE: "true"
          TRIVY_EXIT_CODE: "1"

      - pipe: docker://nayaksuraj/helm-pipe:1.0.0
        variables:
          HELM_CHART_PATH: "./helm-chart"
          CHART_VERSION: "${BITBUCKET_TAG#v}"
          LINT_CHART: "true"
          PACKAGE_CHART: "true"
          PUSH_CHART: "true"

      - step:
          name: ðŸš€ Deploy to Production
          deployment: production
          trigger: manual
          script:
            - pipe: docker://nayaksuraj/deploy-pipe:1.0.0
              variables:
                ENVIRONMENT: "production"
                DEPLOY_NAMESPACE: "production"
                KUBECONFIG: $KUBECONFIG_PRODUCTION
                HELM_CHART_PATH: "./helm-chart"
                HELM_VALUES_FILE: "values-production.yaml"
                DEPLOYMENT_STRATEGY: "canary"

      - pipe: docker://nayaksuraj/slack-pipe:1.0.0
        variables:
          SLACK_WEBHOOK_URL: $SLACK_WEBHOOK_URL
          MESSAGE: "ðŸŽ‰ v${BITBUCKET_TAG#v} deployed to PRODUCTION"
          ENVIRONMENT: "production"
          TITLE: "Production Release"
          MENTION_CHANNEL: "channel"
          CUSTOM_FIELDS: '{"Version":"${BITBUCKET_TAG#v}","Deployment":"Canary â†’ Full Rollout"}'
