# ==============================================================================
# Production-Ready Java Maven Pipeline
# ==============================================================================
# Based on Netflix, Amazon, and Google best practices for Java CI/CD
# Features:
# - Multi-module Maven support
# - Parallel test execution
# - JaCoCo code coverage with quality gates
# - SonarQube integration
# - Dependency caching
# - Security scanning (OWASP, Trivy)
# - Docker multi-stage builds
# - Kubernetes deployment with canary releases
# ==============================================================================

image: maven:3.9-openjdk-17

definitions:
  caches:
    maven: ~/.m2/repository
    sonar: ~/.sonar/cache

  services:
    docker:
      memory: 2048

  steps:
    build: &build-step
      step:
        name: Build & Unit Tests
        caches:
          - maven
        script:
          - mvn clean verify -B -T 2C -Dmaven.test.failure.ignore=false
          - mvn jacoco:report
        artifacts:
          - target/**/*.jar
          - target/site/jacoco/**
          - target/surefire-reports/**

    quality: &quality-step
      step:
        name: Code Quality Analysis
        caches:
          - maven
          - sonar
        script:
          - mvn sonar:sonar -Dsonar.host.url=$SONAR_HOST_URL -Dsonar.login=$SONAR_TOKEN
          - |
            # Check quality gate status
            TASK_ID=$(cat target/sonar/report-task.txt | grep ceTaskId | cut -d'=' -f2)
            echo "SonarQube task ID: $TASK_ID"

pipelines:
  default:
    - parallel:
        - pipe: docker://nayaksuraj/build-pipe:1.0.0
          variables:
            BUILD_TOOL: "maven"
            BUILD_ARGS: "-DskipTests -T 2C"
        - pipe: docker://nayaksuraj/test-pipe:1.0.0
          variables:
            TEST_TOOL: "maven"
            COVERAGE_ENABLED: "true"
            COVERAGE_THRESHOLD: "80"

  branches:
    develop:
      - step:
          <<: *build-step

      - parallel:
          - step:
              <<: *quality-step

          - pipe: docker://nayaksuraj/security-pipe:1.0.0
            variables:
              SECRETS_SCAN: "true"
              SCA_SCAN: "true"
              SBOM_GENERATE: "true"
              FAIL_ON_HIGH: "false"

      - pipe: docker://nayaksuraj/docker-pipe:1.0.0
        variables:
          DOCKER_REGISTRY: $DOCKER_REGISTRY
          DOCKER_REPOSITORY: $DOCKER_REPOSITORY
          DOCKER_USERNAME: $DOCKER_USERNAME
          DOCKER_PASSWORD: $DOCKER_PASSWORD
          BUILD_ARGS: "--build-arg JAR_FILE=target/*.jar"
          SCAN_IMAGE: "true"
          PUSH_IMAGE: "true"

      - pipe: docker://nayaksuraj/deploy-pipe:1.0.0
        variables:
          ENVIRONMENT: "dev"
          NAMESPACE: "development"
          KUBECONFIG: $KUBECONFIG

    main:
      - step:
          <<: *build-step

      - parallel:
          - step:
              <<: *quality-step

          - pipe: docker://nayaksuraj/security-pipe:1.0.0
            variables:
              SECRETS_SCAN: "true"
              SCA_SCAN: "true"
              SAST_SCAN: "true"
              SBOM_GENERATE: "true"
              IAC_SCAN: "true"
              DOCKERFILE_SCAN: "true"
              FAIL_ON_HIGH: "true"

      - step:
          name: Integration Tests
          services:
            - docker
          caches:
            - maven
          script:
            - mvn verify -Pfailsafe -B
          artifacts:
            - target/failsafe-reports/**

      - pipe: docker://nayaksuraj/docker-pipe:1.0.0
        variables:
          DOCKER_REGISTRY: $DOCKER_REGISTRY
          DOCKER_REPOSITORY: $DOCKER_REPOSITORY
          DOCKER_USERNAME: $DOCKER_USERNAME
          DOCKER_PASSWORD: $DOCKER_PASSWORD
          IMAGE_TAG: "${BITBUCKET_COMMIT:0:7}"
          SCAN_IMAGE: "true"
          TRIVY_SEVERITY: "CRITICAL,HIGH"
          PUSH_IMAGE: "true"

      - pipe: docker://nayaksuraj/helm-pipe:1.0.0
        variables:
          HELM_CHART_PATH: "./helm-chart"
          LINT_CHART: "true"
          PACKAGE_CHART: "true"
          PUSH_CHART: "true"

      - pipe: docker://nayaksuraj/deploy-pipe:1.0.0
        variables:
          ENVIRONMENT: "staging"
          NAMESPACE: "staging"
          KUBECONFIG: $KUBECONFIG
          WAIT_FOR_ROLLOUT: "true"
        trigger: manual

  tags:
    'v*':
      - step:
          <<: *build-step

      - parallel:
          - step:
              <<: *quality-step

          - pipe: docker://nayaksuraj/security-pipe:1.0.0
            variables:
              SECRETS_SCAN: "true"
              SCA_SCAN: "true"
              SAST_SCAN: "true"
              SBOM_GENERATE: "true"
              FAIL_ON_HIGH: "true"

      - step:
          name: Release Build
          caches:
            - maven
          script:
            - mvn versions:set -DnewVersion=${BITBUCKET_TAG#v}
            - mvn clean package -DskipTests -B
          artifacts:
            - target/*.jar

      - pipe: docker://nayaksuraj/docker-pipe:1.0.0
        variables:
          DOCKER_REGISTRY: $DOCKER_REGISTRY
          DOCKER_REPOSITORY: $DOCKER_REPOSITORY
          DOCKER_USERNAME: $DOCKER_USERNAME
          DOCKER_PASSWORD: $DOCKER_PASSWORD
          IMAGE_TAG: "${BITBUCKET_TAG#v}"
          ALSO_TAG_AS_LATEST: "true"
          SCAN_IMAGE: "true"
          PUSH_IMAGE: "true"

      - pipe: docker://nayaksuraj/deploy-pipe:1.0.0
        variables:
          ENVIRONMENT: "production"
          NAMESPACE: "production"
          KUBECONFIG: $KUBECONFIG
          IMAGE_TAG: "${BITBUCKET_TAG#v}"
          WAIT_FOR_ROLLOUT: "true"
          ROLLOUT_TIMEOUT: "600"
        trigger: manual

  pull-requests:
    '**':
      - step:
          <<: *build-step

      - parallel:
          - pipe: docker://nayaksuraj/quality-pipe:1.0.0
            variables:
              SONAR_ENABLED: "true"
              SONAR_TOKEN: $SONAR_TOKEN

          - pipe: docker://nayaksuraj/security-pipe:1.0.0
            variables:
              SECRETS_SCAN: "true"
              SCA_SCAN: "true"

  custom:
    performance-test:
      - step:
          name: JMeter Performance Tests
          services:
            - docker
          script:
            - docker run -v $(pwd)/performance:/tests jmeter-test

    dependency-update:
      - step:
          name: Update Dependencies
          caches:
            - maven
          script:
            - mvn versions:display-dependency-updates
            - mvn versions:use-latest-releases -DallowSnapshots=false
