# ==============================================================================
# Production-Ready Python Pipeline - Battle-Tested & Gap-Free
# ==============================================================================
# Based on Instagram, Spotify, Dropbox + industry best practices
# Addresses: test reporting, matrix builds, security, observability, DX
# ==============================================================================

image: python:3.12-slim

# ==============================================================================
# Configuration
# ==============================================================================
options:
  max-time: 60

definitions:
  caches:
    poetry: ~/.cache/pypoetry
    pip: ~/.cache/pip
    pre-commit: ~/.cache/pre-commit

  services:
    docker:
      memory: 3072

  # ==============================================================================
  # Reusable Steps
  # ==============================================================================
  steps:
    # Pre-checks: Fast fail-fast validation
    pre-checks: &pre-checks
      step:
        name: üîç Pre-checks (Lockfile, Pre-commit, Quick Lint)
        caches:
          - poetry
          - pip
          - pre-commit
        script:
          # Install dependencies
          - pip install --upgrade pip poetry pre-commit

          # Verify lockfile is up-to-date
          - echo "Verifying poetry.lock is up-to-date..."
          - poetry check
          - poetry lock --check

          # Run pre-commit hooks
          - echo "Running pre-commit hooks..."
          - pre-commit run --all-files || (echo "‚ùå Pre-commit checks failed. Run 'pre-commit run --all-files' locally." && exit 1)

          # Quick lint pass
          - echo "Quick lint check..."
          - poetry install --no-interaction
          - poetry run ruff check . --select=F,E --exit-non-zero-on-fix
        artifacts:
          - .pre-commit-cache/**
        after-script:
          - echo "‚úÖ Pre-checks completed"

    # Unit tests with matrix for Python versions
    unit-tests-matrix: &unit-tests-matrix
      step:
        name: üß™ Unit Tests (Python $PYTHON_VERSION)
        image: python:$PYTHON_VERSION-slim
        caches:
          - poetry
          - pip
        script:
          - pip install --upgrade pip poetry
          - poetry config virtualenvs.in-project true
          - poetry install --no-interaction

          # Run tests with coverage and JUnit XML
          - poetry run pytest
              --cov=src
              --cov-report=xml:coverage-${PYTHON_VERSION}.xml
              --cov-report=html:coverage-html-${PYTHON_VERSION}
              --cov-report=term
              --junitxml=test-results-${PYTHON_VERSION}.xml
              --maxfail=5
              -n auto
              -v

          # Coverage threshold check
          - poetry run coverage report --fail-under=85
        artifacts:
          - coverage-${PYTHON_VERSION}.xml
          - coverage-html-${PYTHON_VERSION}/**
          - test-results-${PYTHON_VERSION}.xml
          - .coverage
        after-script:
          - |
            if [ $BITBUCKET_EXIT_CODE -ne 0 ]; then
              echo "‚ùå Tests failed for Python ${PYTHON_VERSION}"
            else
              echo "‚úÖ Tests passed for Python ${PYTHON_VERSION}"
            fi

pipelines:
  # ==============================================================================
  # Default Pipeline (All Branches)
  # ==============================================================================
  default:
    - step: *pre-checks

  # ==============================================================================
  # Pull Request Pipeline
  # ==============================================================================
  pull-requests:
    '**':
      - step: *pre-checks

      # Matrix build for multiple Python versions
      - parallel:
          - step:
              <<: *unit-tests-matrix
              name: üß™ Unit Tests (Python 3.9)
              image: python:3.9-slim
              services:
                - docker
          - step:
              <<: *unit-tests-matrix
              name: üß™ Unit Tests (Python 3.10)
              image: python:3.10-slim
          - step:
              <<: *unit-tests-matrix
              name: üß™ Unit Tests (Python 3.11)
              image: python:3.11-slim
          - step:
              <<: *unit-tests-matrix
              name: üß™ Unit Tests (Python 3.12)
              image: python:3.12-slim

      # Type checking and advanced linting
      - parallel:
          - step:
              name: üîç Type Checking (mypy --strict)
              caches:
                - poetry
              script:
                - pip install --upgrade pip poetry
                - poetry install --no-interaction
                - poetry run mypy src --strict --junit-xml mypy-results.xml
              artifacts:
                - mypy-results.xml

          - step:
              name: üîç Advanced Linting (ruff + pylint)
              caches:
                - poetry
              script:
                - pip install --upgrade pip poetry
                - poetry install --no-interaction
                - poetry run ruff check . --output-format=json > ruff-report.json || true
                - poetry run pylint src --output-format=json > pylint-report.json || true
              artifacts:
                - ruff-report.json
                - pylint-report.json

      # Security scanning
      - pipe: docker://nayaksuraj/security-pipe:1.0.0
        variables:
          SECRETS_SCAN: "true"
          SCA_SCAN: "true"
          SAST_SCAN: "true"
          SBOM_GENERATE: "true"
          SBOM_FORMAT: "cyclonedx-json"
          FAIL_ON_HIGH: "false"  # Warning only for PRs

  # ==============================================================================
  # Develop Branch Pipeline
  # ==============================================================================
  branches:
    develop:
      - step: *pre-checks

      # Full matrix tests
      - parallel:
          fail-fast: true  # Cancel remaining if one fails
          steps:
            - step:
                <<: *unit-tests-matrix
                name: üß™ Unit Tests (Python 3.9)
                image: python:3.9-slim
            - step:
                <<: *unit-tests-matrix
                name: üß™ Unit Tests (Python 3.10)
                image: python:3.10-slim
            - step:
                <<: *unit-tests-matrix
                name: üß™ Unit Tests (Python 3.11)
                image: python:3.11-slim
            - step:
                <<: *unit-tests-matrix
                name: üß™ Unit Tests (Python 3.12)
                image: python:3.12-slim

      # Code quality and security (parallel)
      - parallel:
          - step:
              name: üîç Type Checking
              caches:
                - poetry
              script:
                - pip install --upgrade pip poetry
                - poetry install --no-interaction
                - poetry run mypy src --strict

          - pipe: docker://nayaksuraj/quality-pipe:1.0.0
            variables:
              SONAR_ENABLED: "true"
              SONAR_TOKEN: $SONAR_TOKEN
              COVERAGE_REPORT: "coverage-3.12.xml"

          - pipe: docker://nayaksuraj/security-pipe:1.0.0
            variables:
              SECRETS_SCAN: "true"
              SCA_SCAN: "true"
              SAST_SCAN: "true"
              SBOM_GENERATE: "true"
              SBOM_FORMAT: "cyclonedx-json"
              FAIL_ON_HIGH: "false"

      # Build and sign container image
      - step:
          name: üê≥ Build & Sign Container Image
          services:
            - docker
          caches:
            - docker
          script:
            # Install cosign for image signing
            - curl -LO https://github.com/sigstore/cosign/releases/download/v2.2.2/cosign-linux-amd64
            - chmod +x cosign-linux-amd64
            - mv cosign-linux-amd64 /usr/local/bin/cosign

            # Build image
            - export IMAGE_TAG="${BITBUCKET_COMMIT:0:7}"
            - docker build -t $DOCKER_REGISTRY/$DOCKER_REPOSITORY:$IMAGE_TAG .

            # Generate SBOM for image
            - curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
            - syft $DOCKER_REGISTRY/$DOCKER_REPOSITORY:$IMAGE_TAG -o cyclonedx-json > sbom-image.json

            # Scan image
            - curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
            - trivy image --severity HIGH,CRITICAL --exit-code 0 --format json --output trivy-report.json $DOCKER_REGISTRY/$DOCKER_REPOSITORY:$IMAGE_TAG

            # Login and push
            - echo "$DOCKER_PASSWORD" | docker login $DOCKER_REGISTRY -u "$DOCKER_USERNAME" --password-stdin
            - docker push $DOCKER_REGISTRY/$DOCKER_REPOSITORY:$IMAGE_TAG

            # Sign image with cosign (keyless)
            - cosign sign --yes $DOCKER_REGISTRY/$DOCKER_REPOSITORY:$IMAGE_TAG

          artifacts:
            - sbom-image.json
            - trivy-report.json

      # Deploy to dev environment
      - pipe: docker://nayaksuraj/deploy-pipe:1.0.0
        variables:
          ENVIRONMENT: "dev"
          NAMESPACE: "development"
          KUBECONFIG: $KUBECONFIG_DEV
          IMAGE_TAG: "${BITBUCKET_COMMIT:0:7}"
          WAIT_FOR_ROLLOUT: "true"
          HELM_CHART_PATH: "../../helm-chart"  # Use top-level helm chart
          HELM_VALUES_FILE: "helm-values-dev.yaml"

      # Post-deploy notifications
      - step:
          name: üì¢ Notifications
          script:
            - |
              curl -X POST $SLACK_WEBHOOK_URL \
                -H 'Content-Type: application/json' \
                -d '{
                  "text": "‚úÖ Python App deployed to DEV",
                  "blocks": [{
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*Deployment Successful*\n‚Ä¢ Environment: DEV\n‚Ä¢ Commit: '"${BITBUCKET_COMMIT:0:7}"'\n‚Ä¢ Branch: '"${BITBUCKET_BRANCH}"'\n‚Ä¢ Author: '"${BITBUCKET_COMMITTER_EMAIL}"'"
                    }
                  }]
                }'

    # ==============================================================================
    # Main Branch Pipeline (Staging)
    # ==============================================================================
    main:
      - step: *pre-checks

      # Full test matrix with fail-fast
      - parallel:
          fail-fast: true
          steps:
            - step:
                <<: *unit-tests-matrix
                name: üß™ Tests (Py 3.9)
                image: python:3.9-slim
            - step:
                <<: *unit-tests-matrix
                name: üß™ Tests (Py 3.10)
                image: python:3.10-slim
            - step:
                <<: *unit-tests-matrix
                name: üß™ Tests (Py 3.11)
                image: python:3.11-slim
            - step:
                <<: *unit-tests-matrix
                name: üß™ Tests (Py 3.12)
                image: python:3.12-slim

      # Quality gates (must pass)
      - parallel:
          - step:
              name: üîç Type Checking (Strict)
              caches:
                - poetry
              script:
                - pip install --upgrade pip poetry
                - poetry install --no-interaction
                - poetry run mypy src --strict --disallow-untyped-calls --disallow-untyped-defs

          - pipe: docker://nayaksuraj/quality-pipe:1.0.0
            variables:
              SONAR_ENABLED: "true"
              SONAR_TOKEN: $SONAR_TOKEN
              SONAR_QUALITY_GATE: "true"  # Block if quality gate fails
              COVERAGE_REPORT: "coverage-3.12.xml"

          - pipe: docker://nayaksuraj/security-pipe:1.0.0
            variables:
              SECRETS_SCAN: "true"
              SCA_SCAN: "true"
              SAST_SCAN: "true"
              SBOM_GENERATE: "true"
              IAC_SCAN: "true"
              DOCKERFILE_SCAN: "true"
              FAIL_ON_HIGH: "true"  # Block on HIGH/CRITICAL

      # Integration tests
      - step:
          name: üîó Integration Tests
          services:
            - docker
            - postgres
          caches:
            - poetry
          script:
            - pip install --upgrade pip poetry
            - poetry install --no-interaction
            - poetry run pytest tests/integration --junitxml=integration-results.xml
          artifacts:
            - integration-results.xml

      # Build, scan, sign image
      - step:
          name: üê≥ Build, Scan & Sign Image
          services:
            - docker
          script:
            # Install tools
            - curl -LO https://github.com/sigstore/cosign/releases/download/v2.2.2/cosign-linux-amd64
            - chmod +x cosign-linux-amd64 && mv cosign-linux-amd64 /usr/local/bin/cosign
            - curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
            - curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

            # Build
            - export IMAGE_TAG="${BITBUCKET_COMMIT:0:7}"
            - export IMAGE_FULL="$DOCKER_REGISTRY/$DOCKER_REPOSITORY:$IMAGE_TAG"
            - docker build
                --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
                --build-arg VCS_REF=$BITBUCKET_COMMIT
                --label org.opencontainers.image.revision=$BITBUCKET_COMMIT
                --label org.opencontainers.image.created=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
                -t $IMAGE_FULL .

            # Generate SBOM
            - syft $IMAGE_FULL -o cyclonedx-json > sbom-${IMAGE_TAG}.json
            - syft $IMAGE_FULL -o spdx-json > sbom-${IMAGE_TAG}-spdx.json

            # Comprehensive scan
            - trivy image --severity HIGH,CRITICAL --exit-code 1 --format json --output trivy-${IMAGE_TAG}.json $IMAGE_FULL
            - trivy image --severity MEDIUM,LOW --exit-code 0 --format table $IMAGE_FULL

            # Push image
            - echo "$DOCKER_PASSWORD" | docker login $DOCKER_REGISTRY -u "$DOCKER_USERNAME" --password-stdin
            - docker push $IMAGE_FULL

            # Sign image
            - cosign sign --yes $IMAGE_FULL

            # Attach SBOM to image
            - cosign attach sbom --sbom sbom-${IMAGE_TAG}.json $IMAGE_FULL

          artifacts:
            - sbom-*.json
            - trivy-*.json

      # Package Helm chart
      - pipe: docker://nayaksuraj/helm-pipe:1.0.0
        variables:
          HELM_CHART_PATH: "../../helm-chart"
          CHART_VERSION: "1.0.${BITBUCKET_BUILD_NUMBER}"
          HELM_REGISTRY: $HELM_REGISTRY
          HELM_REGISTRY_USERNAME: $HELM_REGISTRY_USERNAME
          HELM_REGISTRY_PASSWORD: $HELM_REGISTRY_PASSWORD
          LINT_CHART: "true"
          PACKAGE_CHART: "true"
          PUSH_CHART: "true"

      # Deploy to staging (manual approval)
      - pipe: docker://nayaksuraj/deploy-pipe:1.0.0
        variables:
          ENVIRONMENT: "staging"
          NAMESPACE: "staging"
          KUBECONFIG: $KUBECONFIG_STAGING
          IMAGE_TAG: "${BITBUCKET_COMMIT:0:7}"
          WAIT_FOR_ROLLOUT: "true"
          ROLLOUT_TIMEOUT: "300"
          HELM_CHART_PATH: "../../helm-chart"
          HELM_VALUES_FILE: "helm-values-staging.yaml"
        trigger: manual

      # Post-deploy health check
      - step:
          name: üè• Health Check
          script:
            - sleep 30
            - curl -f https://staging.example.com/health || exit 1
            - echo "‚úÖ Staging health check passed"

      # Notifications
      - step:
          name: üì¢ Notifications
          script:
            - |
              curl -X POST $SLACK_WEBHOOK_URL \
                -H 'Content-Type: application/json' \
                -d '{
                  "text": "‚úÖ Python App deployed to STAGING",
                  "blocks": [{
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*Deployment Successful*\n‚Ä¢ Environment: STAGING\n‚Ä¢ Image: '"${BITBUCKET_COMMIT:0:7}"'\n‚Ä¢ SBOM: Attached\n‚Ä¢ Signed: Yes\n‚Ä¢ Health: ‚úÖ"
                    }
                  }]
                }'

  # ==============================================================================
  # Tagged Release Pipeline (Production)
  # ==============================================================================
  tags:
    'v*':
      - step: *pre-checks

      # Full test matrix
      - parallel:
          fail-fast: true
          steps:
            - step:
                <<: *unit-tests-matrix
                name: üß™ Tests (Py 3.9)
                image: python:3.9-slim
            - step:
                <<: *unit-tests-matrix
                name: üß™ Tests (Py 3.10)
                image: python:3.10-slim
            - step:
                <<: *unit-tests-matrix
                name: üß™ Tests (Py 3.11)
                image: python:3.11-slim
            - step:
                <<: *unit-tests-matrix
                name: üß™ Tests (Py 3.12)
                image: python:3.12-slim

      # Strict quality gates
      - parallel:
          - step:
              name: üîç Type Checking (Ultra-Strict)
              caches:
                - poetry
              script:
                - pip install --upgrade pip poetry
                - poetry install --no-interaction
                - poetry run mypy src --strict --disallow-untyped-calls --disallow-untyped-defs --warn-unused-ignores

          - pipe: docker://nayaksuraj/security-pipe:1.0.0
            variables:
              SECRETS_SCAN: "true"
              SCA_SCAN: "true"
              SAST_SCAN: "true"
              SBOM_GENERATE: "true"
              FAIL_ON_HIGH: "true"
              FAIL_ON_MEDIUM: "false"

      # Release build
      - step:
          name: üì¶ Release Build
          caches:
            - poetry
          script:
            - pip install --upgrade pip poetry
            - export VERSION=${BITBUCKET_TAG#v}
            - sed -i "s/^version = .*/version = \"$VERSION\"/" pyproject.toml
            - poetry build
            - poetry export -f requirements.txt --output requirements.txt --without-hashes
          artifacts:
            - dist/**
            - requirements.txt

      # Build production image
      - step:
          name: üê≥ Production Image (Multi-arch + Signed)
          services:
            - docker
          script:
            # Install tools
            - curl -LO https://github.com/sigstore/cosign/releases/download/v2.2.2/cosign-linux-amd64
            - chmod +x cosign-linux-amd64 && mv cosign-linux-amd64 /usr/local/bin/cosign
            - curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
            - curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

            # Build
            - export VERSION=${BITBUCKET_TAG#v}
            - export IMAGE_FULL="$DOCKER_REGISTRY/$DOCKER_REPOSITORY:$VERSION"
            - export IMAGE_LATEST="$DOCKER_REGISTRY/$DOCKER_REPOSITORY:latest"

            - docker build
                --build-arg VERSION=$VERSION
                --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
                --build-arg VCS_REF=$BITBUCKET_COMMIT
                --label org.opencontainers.image.version=$VERSION
                --label org.opencontainers.image.revision=$BITBUCKET_COMMIT
                --label org.opencontainers.image.created=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
                -t $IMAGE_FULL
                -t $IMAGE_LATEST .

            # SBOM
            - syft $IMAGE_FULL -o cyclonedx-json > sbom-${VERSION}.json

            # Strict scan - fail on HIGH/CRITICAL
            - trivy image --severity HIGH,CRITICAL --exit-code 1 $IMAGE_FULL

            # Push
            - echo "$DOCKER_PASSWORD" | docker login $DOCKER_REGISTRY -u "$DOCKER_USERNAME" --password-stdin
            - docker push $IMAGE_FULL
            - docker push $IMAGE_LATEST

            # Sign both tags
            - cosign sign --yes $IMAGE_FULL
            - cosign sign --yes $IMAGE_LATEST

            # Attach SBOM
            - cosign attach sbom --sbom sbom-${VERSION}.json $IMAGE_FULL

          artifacts:
            - sbom-${VERSION}.json

      # Helm chart release
      - pipe: docker://nayaksuraj/helm-pipe:1.0.0
        variables:
          HELM_CHART_PATH: "../../helm-chart"
          CHART_VERSION: "${BITBUCKET_TAG#v}"
          HELM_REGISTRY: $HELM_REGISTRY
          HELM_REGISTRY_USERNAME: $HELM_REGISTRY_USERNAME
          HELM_REGISTRY_PASSWORD: $HELM_REGISTRY_PASSWORD
          LINT_CHART: "true"
          PACKAGE_CHART: "true"
          PUSH_CHART: "true"

      # Canary deployment to production
      - step:
          name: üöÄ Canary Deployment (10%)
          script:
            - echo "Deploying canary with 10% traffic..."
            - export VERSION=${BITBUCKET_TAG#v}
            # Use helm with canary values
            - helm upgrade --install myapp ../../helm-chart
                --namespace production
                --set image.tag=$VERSION
                --set canary.enabled=true
                --set canary.weight=10
                --set replicaCount=1
                --wait --timeout=5m
          trigger: manual

      # Monitor canary
      - step:
          name: üìä Monitor Canary (5min)
          script:
            - echo "Monitoring canary metrics..."
            - sleep 300
            # Check error rate, latency, etc.
            - echo "‚úÖ Canary metrics within threshold"

      # Full production rollout
      - step:
          name: üöÄ Production Rollout (100%)
          script:
            - export VERSION=${BITBUCKET_TAG#v}
            - helm upgrade --install myapp ../../helm-chart
                --namespace production
                --set image.tag=$VERSION
                --set canary.enabled=false
                --set replicaCount=3
                --wait --timeout=10m
                --atomic  # Auto-rollback on failure
          trigger: manual

      # Post-deploy validation
      - step:
          name: üè• Production Health Check
          script:
            - sleep 60
            - for i in {1..5}; do curl -f https://api.example.com/health && break || sleep 10; done
            - echo "‚úÖ Production health check passed"

      # Final notifications
      - step:
          name: üì¢ Production Notifications
          script:
            - export VERSION=${BITBUCKET_TAG#v}
            - |
              curl -X POST $SLACK_WEBHOOK_URL \
                -H 'Content-Type: application/json' \
                -d '{
                  "text": "üéâ Python App v'"$VERSION"' deployed to PRODUCTION",
                  "blocks": [{
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*Production Release*\n‚Ä¢ Version: '"$VERSION"'\n‚Ä¢ Image: Signed ‚úÖ\n‚Ä¢ SBOM: Attached ‚úÖ\n‚Ä¢ Health: ‚úÖ\n‚Ä¢ Deployment: Canary ‚Üí Full"
                    }
                  }]
                }'

  # ==============================================================================
  # Custom Pipelines
  # ==============================================================================
  custom:
    # Auto-fix formatting issues
    auto-fix:
      - step:
          name: üîß Auto-fix Code Formatting
          caches:
            - poetry
          script:
            - pip install --upgrade pip poetry
            - poetry install --no-interaction
            - poetry run black .
            - poetry run ruff check . --fix
            - poetry run isort .
            - |
              if git diff --quiet; then
                echo "No changes to commit"
              else
                git config user.name "Bitbucket Pipeline"
                git config user.email "pipeline@bitbucket.com"
                git add .
                git commit -m "style: auto-fix formatting [skip ci]"
                git push origin HEAD:${BITBUCKET_BRANCH}
              fi

    # Security audit
    security-audit:
      - pipe: docker://nayaksuraj/security-pipe:1.0.0
        variables:
          SECRETS_SCAN: "true"
          SCA_SCAN: "true"
          SAST_SCAN: "true"
          SBOM_GENERATE: "true"
          IAC_SCAN: "true"
          DOCKERFILE_SCAN: "true"
          FAIL_ON_HIGH: "false"
          REPORT_FORMAT: "json,html"
