# ==============================================================================
# Minimal Reusable Python Pipeline - Uses Only Organizational Pipes
# ==============================================================================
# This pipeline imports organizational pipes WITHOUT copying any logic
# All pipeline intelligence is in the pipes - ZERO code duplication!
#
# To update: Just change pipe versions (e.g., 1.0.0 â†’ 1.1.0)
# See: /REUSABLE-PIPELINES.md for complete guide
# ==============================================================================

image: python:3.11-slim

pipelines:
  # ==============================================================================
  # Pull Requests - Fast Feedback
  # ==============================================================================
  pull-requests:
    '**':
      - pipe: docker://nayaksuraj/lint-pipe:1.0.0
        variables:
          # Auto-detects Python - no LANGUAGE variable needed!
          PRE_COMMIT_ENABLED: "true"
          LOCKFILE_CHECK: "true"
          LINT_ENABLED: "true"
          TYPE_CHECK_ENABLED: "true"

      - pipe: docker://nayaksuraj/test-pipe:1.0.0
        # Auto-detects pytest from pyproject.toml - no TEST_TOOL needed!
        variables:
          COVERAGE_ENABLED: "true"

      - parallel:
          - pipe: docker://nayaksuraj/quality-pipe:1.0.0
            variables:
              SONAR_ENABLED: "${SONAR_ENABLED:-false}"
              SONAR_TOKEN: $SONAR_TOKEN

          - pipe: docker://nayaksuraj/security-pipe:1.0.0
            variables:
              SECRETS_SCAN: "true"
              SCA_SCAN: "true"
              FAIL_ON_HIGH: "false"

  # ==============================================================================
  # Develop Branch - Auto-Deploy to Dev
  # ==============================================================================
  branches:
    develop:
      - pipe: docker://nayaksuraj/lint-pipe:1.0.0
        variables:
          # Auto-detects Python - no LANGUAGE variable needed!

      - pipe: docker://nayaksuraj/test-pipe:1.0.0
        # Auto-detects pytest from pyproject.toml - no TEST_TOOL needed!
        variables:
          COVERAGE_ENABLED: "true"

      - parallel:
          - pipe: docker://nayaksuraj/quality-pipe:1.0.0
            variables:
              SONAR_ENABLED: "true"
              SONAR_TOKEN: $SONAR_TOKEN

          - pipe: docker://nayaksuraj/security-pipe:1.0.0
            variables:
              SBOM_GENERATE: "true"
              SAST_SCAN: "true"

      - pipe: docker://nayaksuraj/docker-pipe:1.0.0
        variables:
          DOCKER_REGISTRY: $DOCKER_REGISTRY
          DOCKER_REPOSITORY: $DOCKER_REPOSITORY
          DOCKER_USERNAME: $DOCKER_USERNAME
          DOCKER_PASSWORD: $DOCKER_PASSWORD
          SCAN_IMAGE: "true"

      - pipe: docker://nayaksuraj/deploy-pipe:1.0.0
        variables:
          ENVIRONMENT: "dev"
          DEPLOY_NAMESPACE: "development"
          KUBECONFIG: $KUBECONFIG_DEV
          HELM_CHART_PATH: "../../helm-chart"
          HELM_VALUES_FILE: "helm-values-dev.yaml"

      - pipe: docker://nayaksuraj/notify-pipe:1.0.0
        variables:
          CHANNELS: "slack"
          SLACK_WEBHOOK_URL: $SLACK_WEBHOOK_URL
          MESSAGE: "âœ… Deployed to DEV"
          ENVIRONMENT: "dev"
          STATUS: "success"

  # ==============================================================================
  # Main Branch - Deploy to Staging
  # ==============================================================================
    main:
      - pipe: docker://nayaksuraj/lint-pipe:1.0.0
        variables:
          # Auto-detects Python - no LANGUAGE variable needed!
          TYPE_CHECK_COMMAND: "poetry run mypy src --strict"

      - pipe: docker://nayaksuraj/test-pipe:1.0.0
        # Auto-detects pytest from pyproject.toml - no TEST_TOOL needed!
        variables:
          COVERAGE_ENABLED: "true"

      - parallel:
          - pipe: docker://nayaksuraj/quality-pipe:1.0.0
            variables:
              SONAR_ENABLED: "true"
              SONAR_TOKEN: $SONAR_TOKEN
              QUALITY_GATE_ENABLED: "true"

          - pipe: docker://nayaksuraj/security-pipe:1.0.0
            variables:
              FAIL_ON_HIGH: "true"
              SAST_SCAN: "true"
              IAC_SCAN: "true"

      - pipe: docker://nayaksuraj/docker-pipe:1.0.0
        variables:
          DOCKER_REGISTRY: $DOCKER_REGISTRY
          DOCKER_REPOSITORY: $DOCKER_REPOSITORY
          DOCKER_USERNAME: $DOCKER_USERNAME
          DOCKER_PASSWORD: $DOCKER_PASSWORD
          SCAN_IMAGE: "true"
          TRIVY_EXIT_CODE: "1"

      - pipe: docker://nayaksuraj/helm-pipe:1.0.0
        variables:
          HELM_CHART_PATH: "../../helm-chart"
          LINT_CHART: "true"
          PACKAGE_CHART: "true"

      - step:
          name: ðŸš€ Deploy to Staging
          deployment: staging
          trigger: manual
          script:
            - pipe: docker://nayaksuraj/deploy-pipe:1.0.0
              variables:
                ENVIRONMENT: "staging"
                DEPLOY_NAMESPACE: "staging"
                KUBECONFIG: $KUBECONFIG_STAGING
                HELM_CHART_PATH: "../../helm-chart"
                HELM_VALUES_FILE: "helm-values-staging.yaml"

      - pipe: docker://nayaksuraj/notify-pipe:1.0.0
        variables:
          CHANNELS: "slack"
          SLACK_WEBHOOK_URL: $SLACK_WEBHOOK_URL
          MESSAGE: "âœ… Deployed to STAGING"
          ENVIRONMENT: "staging"
          STATUS: "success"
          TITLE: "Staging Deployment"

  # ==============================================================================
  # Tagged Releases - Production Deployment
  # ==============================================================================
  tags:
    'v*':
      - pipe: docker://nayaksuraj/lint-pipe:1.0.0
        variables:
          # Auto-detects Python - no LANGUAGE variable needed!
          TYPE_CHECK_COMMAND: "poetry run mypy src --strict --disallow-untyped-defs"

      - pipe: docker://nayaksuraj/test-pipe:1.0.0
        # Auto-detects pytest from pyproject.toml - no TEST_TOOL needed!
        variables:
          COVERAGE_ENABLED: "true"

      - pipe: docker://nayaksuraj/security-pipe:1.0.0
        variables:
          FAIL_ON_HIGH: "true"
          SAST_SCAN: "true"

      - pipe: docker://nayaksuraj/docker-pipe:1.0.0
        variables:
          DOCKER_REGISTRY: $DOCKER_REGISTRY
          DOCKER_REPOSITORY: $DOCKER_REPOSITORY
          DOCKER_USERNAME: $DOCKER_USERNAME
          DOCKER_PASSWORD: $DOCKER_PASSWORD
          IMAGE_TAG: "${BITBUCKET_TAG#v}"
          SCAN_IMAGE: "true"
          TRIVY_EXIT_CODE: "1"

      - pipe: docker://nayaksuraj/helm-pipe:1.0.0
        variables:
          HELM_CHART_PATH: "../../helm-chart"
          CHART_VERSION: "${BITBUCKET_TAG#v}"
          HELM_REGISTRY: $HELM_REGISTRY
          HELM_REGISTRY_USERNAME: $HELM_REGISTRY_USERNAME
          HELM_REGISTRY_PASSWORD: $HELM_REGISTRY_PASSWORD
          LINT_CHART: "true"
          PACKAGE_CHART: "true"
          PUSH_CHART: "true"

      - step:
          name: ðŸš€ Deploy to Production
          deployment: production
          trigger: manual
          script:
            - pipe: docker://nayaksuraj/deploy-pipe:1.0.0
              variables:
                ENVIRONMENT: "production"
                DEPLOY_NAMESPACE: "production"
                KUBECONFIG: $KUBECONFIG_PRODUCTION
                HELM_CHART_PATH: "../../helm-chart"
                HELM_VALUES_FILE: "helm-values-production.yaml"
                DEPLOYMENT_STRATEGY: "canary"

      - pipe: docker://nayaksuraj/notify-pipe:1.0.0
        variables:
          CHANNELS: "slack"
          SLACK_WEBHOOK_URL: $SLACK_WEBHOOK_URL
          MESSAGE: "ðŸŽ‰ v${BITBUCKET_TAG#v} deployed to PRODUCTION"
          ENVIRONMENT: "production"
          STATUS: "success"
          TITLE: "Production Release"
          MENTION_CHANNEL: "channel"
          CUSTOM_FIELDS: '{"Version":"${BITBUCKET_TAG#v}","Deployment":"Canary â†’ Full Rollout"}'
