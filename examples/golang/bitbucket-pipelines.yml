# ==============================================================================
# Production-Ready Go Pipeline
# ==============================================================================
# Based on Google, Uber, and HashiCorp best practices for Go CI/CD
# Features:
# - Go modules with vendor caching
# - Race detection and benchmarks
# - golangci-lint with comprehensive checks
# - Code coverage with go test
# - Security scanning (gosec, govulncheck)
# - Minimal Docker images with multi-stage builds
# - Cross-platform builds
# ==============================================================================

image: golang:1.21-alpine

definitions:
  caches:
    gomod: /go/pkg/mod
    gocache: ~/.cache/go-build

pipelines:
  default:
    - parallel:
        - pipe: docker://nayaksuraj/build-pipe:1.0.0
          variables:
            BUILD_TOOL: "go"
            BUILD_COMMAND: "go build -v ./..."

        - pipe: docker://nayaksuraj/test-pipe:1.0.0
          variables:
            TEST_TOOL: "go"
            TEST_COMMAND: "go test -v -race -coverprofile=coverage.out -covermode=atomic ./..."
            COVERAGE_ENABLED: "true"
            COVERAGE_THRESHOLD: "80"

  branches:
    develop:
      - step:
          name: Build & Test
          caches:
            - gomod
            - gocache
          script:
            - go mod download
            - go mod verify
            - go build -v ./...
            - go test -v -race -coverprofile=coverage.out -covermode=atomic ./...
            - go tool cover -html=coverage.out -o coverage.html
          artifacts:
            - coverage.out
            - coverage.html

      - parallel:
          - step:
              name: Linting & Static Analysis
              caches:
                - gomod
              script:
                - apk add --no-cache git
                - wget -O- -nv https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s latest
                - ./bin/golangci-lint run --timeout 5m

          - pipe: docker://nayaksuraj/security-pipe:1.0.0
            variables:
              SECRETS_SCAN: "true"
              SCA_SCAN: "true"
              SAST_SCAN: "true"
              SBOM_GENERATE: "true"

      - step:
          name: Benchmarks
          caches:
            - gomod
          script:
            - go test -bench=. -benchmem ./... | tee benchmark.txt
          artifacts:
            - benchmark.txt

      - pipe: docker://nayaksuraj/docker-pipe:1.0.0
        variables:
          DOCKER_REGISTRY: $DOCKER_REGISTRY
          DOCKER_REPOSITORY: $DOCKER_REPOSITORY
          DOCKER_USERNAME: $DOCKER_USERNAME
          DOCKER_PASSWORD: $DOCKER_PASSWORD
          SCAN_IMAGE: "true"
          PUSH_IMAGE: "true"

      - pipe: docker://nayaksuraj/deploy-pipe:1.0.0
        variables:
          ENVIRONMENT: "dev"
          NAMESPACE: "development"
          KUBECONFIG: $KUBECONFIG

    main:
      - step:
          name: Build & Comprehensive Tests
          caches:
            - gomod
            - gocache
          script:
            - go mod download
            - go mod verify
            - go vet ./...
            - go build -v ./...
            - go test -v -race -coverprofile=coverage.out -covermode=atomic ./...
            - go test -v -tags=integration ./...
          artifacts:
            - coverage.out

      - parallel:
          - pipe: docker://nayaksuraj/quality-pipe:1.0.0
            variables:
              SONAR_ENABLED: "true"
              SONAR_TOKEN: $SONAR_TOKEN

          - pipe: docker://nayaksuraj/security-pipe:1.0.0
            variables:
              SECRETS_SCAN: "true"
              SCA_SCAN: "true"
              SAST_SCAN: "true"
              SBOM_GENERATE: "true"
              FAIL_ON_HIGH: "true"

      - step:
          name: Cross-Platform Build
          caches:
            - gomod
          script:
            - |
              for OS in linux darwin windows; do
                for ARCH in amd64 arm64; do
                  echo "Building $OS/$ARCH"
                  GOOS=$OS GOARCH=$ARCH go build -o bin/app-$OS-$ARCH ./cmd/app
                done
              done
          artifacts:
            - bin/**

      - pipe: docker://nayaksuraj/docker-pipe:1.0.0
        variables:
          DOCKER_REGISTRY: $DOCKER_REGISTRY
          DOCKER_REPOSITORY: $DOCKER_REPOSITORY
          DOCKER_USERNAME: $DOCKER_USERNAME
          DOCKER_PASSWORD: $DOCKER_PASSWORD
          IMAGE_TAG: "${BITBUCKET_COMMIT:0:7}"
          SCAN_IMAGE: "true"
          PUSH_IMAGE: "true"

      - pipe: docker://nayaksuraj/deploy-pipe:1.0.0
        variables:
          ENVIRONMENT: "staging"
          NAMESPACE: "staging"
          KUBECONFIG: $KUBECONFIG
        trigger: manual

  tags:
    'v*':
      - step:
          name: Build Release
          caches:
            - gomod
          script:
            - go mod download
            - go build -ldflags "-X main.version=${BITBUCKET_TAG}" -o app ./cmd/app
          artifacts:
            - app

      - pipe: docker://nayaksuraj/security-pipe:1.0.0
        variables:
          SECRETS_SCAN: "true"
          SCA_SCAN: "true"
          SBOM_GENERATE: "true"
          FAIL_ON_HIGH: "true"

      - pipe: docker://nayaksuraj/docker-pipe:1.0.0
        variables:
          DOCKER_REGISTRY: $DOCKER_REGISTRY
          DOCKER_REPOSITORY: $DOCKER_REPOSITORY
          DOCKER_USERNAME: $DOCKER_USERNAME
          DOCKER_PASSWORD: $DOCKER_PASSWORD
          IMAGE_TAG: "${BITBUCKET_TAG#v}"
          ALSO_TAG_AS_LATEST: "true"
          SCAN_IMAGE: "true"
          PUSH_IMAGE: "true"

      - pipe: docker://nayaksuraj/deploy-pipe:1.0.0
        variables:
          ENVIRONMENT: "production"
          NAMESPACE: "production"
          KUBECONFIG: $KUBECONFIG
          IMAGE_TAG: "${BITBUCKET_TAG#v}"
          WAIT_FOR_ROLLOUT: "true"
        trigger: manual

  pull-requests:
    '**':
      - pipe: docker://nayaksuraj/build-pipe:1.0.0
        variables:
          BUILD_TOOL: "go"

      - parallel:
          - pipe: docker://nayaksuraj/test-pipe:1.0.0
            variables:
              TEST_TOOL: "go"
              TEST_COMMAND: "go test -v -race ./..."

          - pipe: docker://nayaksuraj/security-pipe:1.0.0
            variables:
              SECRETS_SCAN: "true"
              SCA_SCAN: "true"
