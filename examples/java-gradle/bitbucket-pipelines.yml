# ==============================================================================
# Java Gradle Project - Using Template from nayaksuraj/test-repo
# ==============================================================================
# This pipeline uses the Java Gradle template from nayaksuraj/test-repo
#
# To use this template in your repository:
# 1. Copy pipeline-templates/java-gradle-template.yml from nayaksuraj/test-repo
# 2. Paste as bitbucket-pipelines.yml in your repo
# 3. Configure required Bitbucket variables (see template file)
#
# Template source: https://bitbucket.org/nayaksuraj/test-repo/src/main/pipeline-templates/java-gradle-template.yml
# ==============================================================================

image: gradle:8.5-jdk17

definitions:
  caches:
    gradle: ~/.gradle/caches
    gradle-wrapper: ~/.gradle/wrapper
    sonar: ~/.sonar/cache

  services:
    docker:
      memory: 2048

  steps:
    build: &build-step
      step:
        name: Build & Unit Tests
        caches:
          - gradle
          - gradle-wrapper
        script:
          # Gradle build with parallel execution and build cache
          - ./gradlew clean build --parallel --build-cache --no-daemon -x test
          - ./gradlew test jacocoTestReport --parallel --build-cache --no-daemon
        artifacts:
          - build/libs/**/*.jar
          - build/reports/jacoco/**
          - build/test-results/**

    quality: &quality-step
      step:
        name: Code Quality Analysis
        caches:
          - gradle
          - gradle-wrapper
          - sonar
        script:
          - ./gradlew sonarqube --no-daemon \
              -Dsonar.host.url=$SONAR_HOST_URL \
              -Dsonar.login=$SONAR_TOKEN
          - |
            # Check quality gate status
            echo "SonarQube analysis complete"

pipelines:
  default:
    - parallel:
        - pipe: docker://nayaksuraj/build-pipe:1.0.0
          variables:
            BUILD_ARGS: "--parallel --build-cache --no-daemon -x test"
        - pipe: docker://nayaksuraj/test-pipe:1.0.0
          variables:
            TEST_ARGS: "test --parallel --build-cache --no-daemon"
            COVERAGE_ENABLED: "true"
            COVERAGE_THRESHOLD: "80"

  branches:
    develop:
      - step:
          <<: *build-step

      - parallel:
          - step:
              <<: *quality-step

          - pipe: docker://nayaksuraj/security-pipe:1.0.0
            variables:
              SECRETS_SCAN: "true"
              SCA_SCAN: "true"
              SBOM_GENERATE: "true"
              FAIL_ON_HIGH: "false"

      - pipe: docker://nayaksuraj/docker-pipe:1.0.0
        variables:
          DOCKER_REGISTRY: $DOCKER_REGISTRY
          DOCKER_REPOSITORY: $DOCKER_REPOSITORY
          DOCKER_USERNAME: $DOCKER_USERNAME
          DOCKER_PASSWORD: $DOCKER_PASSWORD
          BUILD_ARGS: "--build-arg JAR_FILE=build/libs/*.jar"
          SCAN_IMAGE: "true"
          PUSH_IMAGE: "true"

      - pipe: docker://nayaksuraj/deploy-pipe:1.0.0
        variables:
          ENVIRONMENT: "dev"
          NAMESPACE: "development"
          KUBECONFIG: $KUBECONFIG

    main:
      - step:
          <<: *build-step

      - parallel:
          - step:
              <<: *quality-step

          - pipe: docker://nayaksuraj/security-pipe:1.0.0
            variables:
              SECRETS_SCAN: "true"
              SCA_SCAN: "true"
              SAST_SCAN: "true"
              SBOM_GENERATE: "true"
              IAC_SCAN: "true"
              DOCKERFILE_SCAN: "true"
              FAIL_ON_HIGH: "true"

      - step:
          name: Integration Tests
          services:
            - docker
          caches:
            - gradle
            - gradle-wrapper
          script:
            - ./gradlew integrationTest --parallel --build-cache --no-daemon
          artifacts:
            - build/reports/tests/integrationTest/**

      - pipe: docker://nayaksuraj/docker-pipe:1.0.0
        variables:
          DOCKER_REGISTRY: $DOCKER_REGISTRY
          DOCKER_REPOSITORY: $DOCKER_REPOSITORY
          DOCKER_USERNAME: $DOCKER_USERNAME
          DOCKER_PASSWORD: $DOCKER_PASSWORD
          IMAGE_TAG: "${BITBUCKET_COMMIT:0:7}"
          SCAN_IMAGE: "true"
          TRIVY_SEVERITY: "CRITICAL,HIGH"
          PUSH_IMAGE: "true"

      - pipe: docker://nayaksuraj/helm-pipe:1.0.0
        variables:
          HELM_CHART_PATH: "./helm-chart"
          LINT_CHART: "true"
          PACKAGE_CHART: "true"
          PUSH_CHART: "true"

      - pipe: docker://nayaksuraj/deploy-pipe:1.0.0
        variables:
          ENVIRONMENT: "staging"
          NAMESPACE: "staging"
          KUBECONFIG: $KUBECONFIG
          WAIT_FOR_ROLLOUT: "true"
        trigger: manual

  tags:
    'v*':
      - step:
          <<: *build-step

      - parallel:
          - step:
              <<: *quality-step

          - pipe: docker://nayaksuraj/security-pipe:1.0.0
            variables:
              SECRETS_SCAN: "true"
              SCA_SCAN: "true"
              SAST_SCAN: "true"
              SBOM_GENERATE: "true"
              FAIL_ON_HIGH: "true"

      - step:
          name: Release Build
          caches:
            - gradle
            - gradle-wrapper
          script:
            - export VERSION=${BITBUCKET_TAG#v}
            - ./gradlew -Pversion=$VERSION clean build --no-daemon -x test
          artifacts:
            - build/libs/*.jar

      - pipe: docker://nayaksuraj/docker-pipe:1.0.0
        variables:
          DOCKER_REGISTRY: $DOCKER_REGISTRY
          DOCKER_REPOSITORY: $DOCKER_REPOSITORY
          DOCKER_USERNAME: $DOCKER_USERNAME
          DOCKER_PASSWORD: $DOCKER_PASSWORD
          IMAGE_TAG: "${BITBUCKET_TAG#v}"
          ALSO_TAG_AS_LATEST: "true"
          SCAN_IMAGE: "true"
          PUSH_IMAGE: "true"

      - pipe: docker://nayaksuraj/deploy-pipe:1.0.0
        variables:
          ENVIRONMENT: "production"
          NAMESPACE: "production"
          KUBECONFIG: $KUBECONFIG
          IMAGE_TAG: "${BITBUCKET_TAG#v}"
          WAIT_FOR_ROLLOUT: "true"
          ROLLOUT_TIMEOUT: "600"
        trigger: manual

  pull-requests:
    '**':
      - step:
          <<: *build-step

      - parallel:
          - pipe: docker://nayaksuraj/quality-pipe:1.0.0
            variables:
              SONAR_ENABLED: "true"
              SONAR_TOKEN: $SONAR_TOKEN

          - pipe: docker://nayaksuraj/security-pipe:1.0.0
            variables:
              SECRETS_SCAN: "true"
              SCA_SCAN: "true"

  custom:
    performance-test:
      - step:
          name: Gatling Performance Tests
          services:
            - docker
          caches:
            - gradle
          script:
            - ./gradlew gatlingRun --no-daemon

    dependency-update:
      - step:
          name: Update Dependencies
          caches:
            - gradle
          script:
            - ./gradlew dependencyUpdates --no-daemon
            - cat build/dependencyUpdates/report.txt
